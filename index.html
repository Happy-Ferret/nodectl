<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>nodectl by geta6</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>nodectl</h1>
        <p>supervisor script for node.js</p>

        <p class="view"><a href="https://github.com/geta6/nodectl">View the Project on GitHub <small>geta6/nodectl</small></a></p>


        <ul>
          <li><a href="https://github.com/geta6/nodectl/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/geta6/nodectl/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/geta6/nodectl">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a name="nodectl" class="anchor" href="#nodectl"><span class="octicon octicon-link"></span></a>nodectl</h1>

<p>supervisor sctipt for nodejs.</p>

<h2>
<a name="" class="anchor" href="#"><span class="octicon octicon-link"></span></a>日本語による解説</h2>

<h3>
<a name="-1" class="anchor" href="#-1"><span class="octicon octicon-link"></span></a>一番の目玉</h3>

<ul>
<li>アプリケーションに関係ないレベルでの作業が不要</li>
<li>httpを一本立てるだけでよい</li>
<li>デーモン化やクラスタリングで頭を悩ませなくてよい</li>
</ul><h3>
<a name="-2" class="anchor" href="#-2"><span class="octicon octicon-link"></span></a>有している作戦能力</h3>

<ul>
<li>CPUのスレッド数に応じて自動的にfork、応答性能を向上</li>
<li>コードに変更を施したらメインプロセスを維持したまま子プロセスのみを自動的にリロード、変更を浸透</li>
<li>浸透のディレイタイムを設定可能</li>
<li>単独でのデーモン化能力</li>
<li>ログのファイル出力機能</li>
<li>
<code>console</code>出力の自動色分け出力機能</li>
<li>
<code>start-stop-daemon</code>のような命令系統</li>
<li>最近傍の<code>package.json</code>を探索、<code>name</code>, <code>version</code>, <code>main</code>と言った情報を取得</li>
<li>最近傍の<code>package.json</code>からキー名を探索、ロングオプションと同値のキーをデフォルト値としてロード</li>
<li>
<code>package.json</code>と同一ディレクトリにある<code>.nodectl.json</code>の値を読み、設定値をロード</li>
<li>オプションで渡した値が最優先され、次に<code>.nodectl.json</code>、次に<code>package.json</code>、次にデフォルト値、という順番で評価</li>
<li>
<code>PORT</code>や<code>NODE_ENV</code>などの環境変数値を<code>undefined</code>のまま実行しない</li>
<li>現在の引数でどのような動作が期待されるかテストするモード</li>
<li>crontabのように動作するスクリプトなど、単一のインスタンスのみで実行されることを期待するスクリプトの指定</li>
</ul><h2>
<a name="features" class="anchor" href="#features"><span class="octicon octicon-link"></span></a>Features</h2>

<ul>
<li>watch code changes</li>
<li>cluster</li>
<li>daemonize</li>
<li>colorize console</li>
<li>env setter</li>
</ul><h2>
<a name="install" class="anchor" href="#install"><span class="octicon octicon-link"></span></a>Install</h2>

<p><code>npm install -g nodectl</code></p>

<h2>
<a name="how-to-use" class="anchor" href="#how-to-use"><span class="octicon octicon-link"></span></a>How to use</h2>

<pre><code>cd $HOME
express test
cd test
npm install
nodectl start app.js
</code></pre>

<h3>
<a name="watch" class="anchor" href="#watch"><span class="octicon octicon-link"></span></a>watch</h3>

<pre><code>nodectl -w app.js
</code></pre>

<h3>
<a name="daemonise" class="anchor" href="#daemonise"><span class="octicon octicon-link"></span></a>daemonise</h3>

<pre><code>nodectl -d app.js
</code></pre>

<h3>
<a name="both" class="anchor" href="#both"><span class="octicon octicon-link"></span></a>both</h3>

<pre><code>nodectl -d -w app.js
</code></pre>

<h3>
<a name="clock-works-ex-crontab-like-action" class="anchor" href="#clock-works-ex-crontab-like-action"><span class="octicon octicon-link"></span></a>clock works (ex. crontab like action)</h3>

<pre><code>nodectl -x clock.js
</code></pre>

<h3>
<a name="stop-daemon" class="anchor" href="#stop-daemon"><span class="octicon octicon-link"></span></a>stop daemon</h3>

<pre><code>cd ~/test
nodectl stop
</code></pre>

<h3>
<a name="daemonize-and" class="anchor" href="#daemonize-and"><span class="octicon octicon-link"></span></a>daemonize and..</h3>

<pre><code>cd ~/test
nodectl start -d app.js
nodectl reload
nodectl restart
nodectl status
  application running.
</code></pre>

<h2>
<a name="usage" class="anchor" href="#usage"><span class="octicon octicon-link"></span></a>Usage</h2>

<p><code>nodectl [action] [options] &lt;program&gt;</code></p>

<h3>
<a name="action" class="anchor" href="#action"><span class="octicon octicon-link"></span></a>Action</h3>

<h4>
<a name="start" class="anchor" href="#start"><span class="octicon octicon-link"></span></a>start</h4>

<p>execute program (default action)</p>

<h4>
<a name="stop" class="anchor" href="#stop"><span class="octicon octicon-link"></span></a>stop</h4>

<p>stop daemonized program</p>

<h4>
<a name="restart" class="anchor" href="#restart"><span class="octicon octicon-link"></span></a>restart</h4>

<p>restart program with daemonize mode</p>

<h4>
<a name="force-clear" class="anchor" href="#force-clear"><span class="octicon octicon-link"></span></a>force-clear</h4>

<p>force clear pid</p>

<h4>
<a name="reload" class="anchor" href="#reload"><span class="octicon octicon-link"></span></a>reload</h4>

<p>release edited javascript (restart only child processes)</p>

<h4>
<a name="status" class="anchor" href="#status"><span class="octicon octicon-link"></span></a>status</h4>

<p>check program running or not</p>

<h3>
<a name="options" class="anchor" href="#options"><span class="octicon octicon-link"></span></a>Options:</h3>

<h4>
<a name="-p---port-number" class="anchor" href="#-p---port-number"><span class="octicon octicon-link"></span></a>-p, --port [NUMBER]</h4>

<p>default 3000, pass listening port (<code>process.env.PORT</code>)</p>

<h4>
<a name="-e---env-string" class="anchor" href="#-e---env-string"><span class="octicon octicon-link"></span></a>-e, --env [STRING]</h4>

<p>default development, pass environment (<code>process.env.NODE_ENV</code>)</p>

<h4>
<a name="-c---cluster-number" class="anchor" href="#-c---cluster-number"><span class="octicon octicon-link"></span></a>-c, --cluster [NUMBER]</h4>

<p>default number of cpu threads, concurrent process with cluster module</p>

<h4>
<a name="-p---pidpath-string" class="anchor" href="#-p---pidpath-string"><span class="octicon octicon-link"></span></a>-P, --pidpath [STRING]</h4>

<p>directory for pid files</p>

<h4>
<a name="-l---logpath-string" class="anchor" href="#-l---logpath-string"><span class="octicon octicon-link"></span></a>-l, --logpath [STRING]</h4>

<p>directory for log files</p>

<h4>
<a name="-d---delay-number" class="anchor" href="#-d---delay-number"><span class="octicon octicon-link"></span></a>-D, --delay [NUMBER]</h4>

<p>default 250, delay time for re-fork child workers</p>

<h4>
<a name="-x---execmaster-string" class="anchor" href="#-x---execmaster-string"><span class="octicon octicon-link"></span></a>-x, --execmaster [STRING]</h4>

<p>execute script on master process (single instance)</p>

<h4>
<a name="-n---nocolor" class="anchor" href="#-n---nocolor"><span class="octicon octicon-link"></span></a>-n, --nocolor</h4>

<p>stop colorize console</p>

<h4>
<a name="-d---daemon" class="anchor" href="#-d---daemon"><span class="octicon octicon-link"></span></a>-d, --daemon</h4>

<p>daemonize process</p>

<h4>
<a name="-w---watch" class="anchor" href="#-w---watch"><span class="octicon octicon-link"></span></a>-w, --watch</h4>

<p>watch code changes, auto reload programs</p>

<h4>
<a name="-t---test" class="anchor" href="#-t---test"><span class="octicon octicon-link"></span></a>-t, --test</h4>

<p>check options (not execute)</p>

<h4>
<a name="-v---version" class="anchor" href="#-v---version"><span class="octicon octicon-link"></span></a>-v, --version</h4>

<p>show version and exit</p>

<h4>
<a name="-h---help" class="anchor" href="#-h---help"><span class="octicon octicon-link"></span></a>-h, --help</h4>

<p>show help message and exit</p>

<h2>
<a name="defaults" class="anchor" href="#defaults"><span class="octicon octicon-link"></span></a>Defaults</h2>

<ul>
<li>Default option values from

<ul>
<li><code>${PROJECT_ROOT}/.nodectl.json</code></li>
<li><code>${PROJECT_ROOT}/package.json</code></li>
</ul>
</li>
<li>Main script key is <code>main</code>
</li>
</ul><h2>
<a name="packagejson-search" class="anchor" href="#packagejson-search"><span class="octicon octicon-link"></span></a>package.json search</h2>

<p>nodectl automatically search nearest <code>package.json</code> form parent directories.</p>

<ul>
<li>application name from <code>package.json: name</code>
</li>
<li>application version from <code>package.json: version</code>
</li>
<li>application main script from <code>package.json: main</code> or <code>.nodectl.json: main</code>
</li>
</ul><h2>
<a name="tips" class="anchor" href="#tips"><span class="octicon octicon-link"></span></a>Tips</h2>

<h3>
<a name="automatically-setting" class="anchor" href="#automatically-setting"><span class="octicon octicon-link"></span></a>automatically setting</h3>

<div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> <span class="nv">$PROJECT_ROOT</span>
<span class="nv">$ </span>cat .nodectl.json
<span class="o">{</span>
  <span class="s2">"main"</span>: <span class="s2">"app.coffee"</span>,
  <span class="s2">"env"</span>: <span class="s2">"development"</span>,
  <span class="s2">"execmaster"</span>: <span class="s2">"config/clock.coffee"</span>,
  <span class="s2">"cluster"</span>: <span class="s2">"1"</span>,
  <span class="s2">"watch"</span>: <span class="nb">true</span>,
  <span class="s2">"daemonize"</span>: <span class="nb">false</span>
<span class="o">}</span>
</pre></div>

<h3>
<a name="prevent-master-process-down-from-execmaster" class="anchor" href="#prevent-master-process-down-from-execmaster"><span class="octicon octicon-link"></span></a>prevent master process down from execmaster</h3>

<div class="highlight"><pre><span class="nx">$</span> <span class="nx">cd</span> <span class="nx">$PROJECT_ROOT</span>
<span class="nx">$</span> <span class="nx">cat</span> <span class="nx">config</span><span class="o">/</span><span class="nx">clock</span><span class="p">.</span><span class="nx">coffee</span>

<span class="nv">fs= </span><span class="nx">require</span> <span class="s">'fs'</span>
<span class="nv">path = </span><span class="nx">require</span> <span class="s">'path'</span>
<span class="nv">async = </span><span class="nx">require</span> <span class="s">'async'</span>
<span class="p">{</span><span class="nx">spawn</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">'child_process'</span>

<span class="k">if</span> <span class="s">'nodectl'</span> <span class="o">is</span> <span class="nx">path</span><span class="p">.</span><span class="nx">basename</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

  <span class="c1"># Manager - spawn myself</span>

  <span class="nx">setInterval</span> <span class="nf">-&gt;</span>
    <span class="nv">args = </span><span class="p">[</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">(),</span> <span class="s">'config/clock.coffee'</span><span class="p">]</span>
    <span class="nx">spawn</span> <span class="s">'./node_modules/coffee-script/bin/coffee'</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span>
      <span class="nv">stdio: </span><span class="s">'inherit'</span>
      <span class="nv">env: </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
      <span class="nv">cwd: </span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()</span>
      <span class="nv">detached: </span><span class="kc">yes</span>
  <span class="p">,</span> <span class="mi">1000</span>

<span class="k">else</span>

  <span class="c1"># Worker - spawned process section</span>

  <span class="nv">app = </span><span class="nx">require</span> <span class="s">'./app.coffee'</span>
  <span class="p">{</span><span class="nx">File</span><span class="p">}</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">'models'</span>

  <span class="nv">root_dir = </span><span class="s">'/media'</span>

  <span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span> <span class="nx">root_dir</span><span class="p">,</span> <span class="nf">(err, list) -&gt;</span>
    <span class="nx">async</span><span class="p">.</span><span class="nx">map</span> <span class="nx">list</span><span class="p">,</span> <span class="nf">(name, next) -&gt;</span>
      <span class="nv">filepath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">root_dir</span><span class="p">,</span> <span class="nx">name</span>
      <span class="nx">File</span><span class="p">.</span><span class="nx">find</span> <span class="nv">path: </span><span class="nx">filepath</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{},</span> <span class="nf">(err, file) -&gt;</span>
        <span class="nv">stat = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="nx">filepath</span>
        <span class="k">unless</span> <span class="nx">file</span>
          <span class="nv">file = </span><span class="k">new</span> <span class="nx">File</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">String</span> <span class="nx">file</span><span class="p">.</span><span class="nx">mtime</span><span class="p">)</span> <span class="o">isnt</span> <span class="p">(</span><span class="nb">String</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">mtime</span><span class="p">)</span>
           <span class="nv">file.path = </span><span class="nx">filepath</span>
          <span class="nv">file.stat = </span><span class="nx">stat</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">save</span> <span class="nx">next</span>
    <span class="p">,</span> <span class="nf">(err) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="nx">err</span> 
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span> <span class="mi">1</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span> <span class="mi">0</span>
</pre></div>

<h2>
<a name="release" class="anchor" href="#release"><span class="octicon octicon-link"></span></a>release</h2>

<div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> <span class="nv">$PROJECT_ROOT</span>
<span class="nv">$ </span>cat .nodectl.json
<span class="o">{</span>
  <span class="s2">"main"</span>: <span class="s2">"app.coffee"</span>,
  <span class="s2">"env"</span>: <span class="s2">"production"</span>,
  <span class="s2">"execmaster"</span>: <span class="s2">"config/clock.coffee"</span>,
  <span class="s2">"daemonize"</span>: <span class="nb">true</span>
<span class="o">}</span>
</pre></div>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/geta6">geta6</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>